<div class="recently_viewed_section">
    <div class="container">
        <div class="section_heading">
            <h2 class="section_title">Recently Viewed Products</h2>
        </div>
        <div class="row" id="recently_viewed_products"> </div>
    </div>
</div>


<script>
    $(document).ready(function () {
        function updateRecentlyViewdProducts() {
            const currentProductData = {
                productId: "{{ product.id }}",
                productTitle: "{{ product.title }}",
                productImage: "{{ product.featured_image | image_url: width: 400 }}",
                price: "{{ product.price | money }}",
                productUrl: "{{ product.url }}"
            };

            const maxProducts = 4;
            const currentProductId = currentProductData.productId;
            const storedData = localStorage.getItem('recently_viewed');

            if (storedData == null) {

                localStorage.setItem('recently_viewed', JSON.stringify([currentProductData]));
            } else {
                const parsedResponsed = JSON.parse(storedData);
                const storedProductCount = parsedResponsed.length;
                const revisitedProduct = parsedResponsed.some(p => p.productId == currentProductId);

                if (storedProductCount < maxProducts && !revisitedProduct) {
                    parsedResponsed.push(currentProductData);
                    localStorage.setItem('recently_viewed', JSON.stringify(parsedResponsed));
                } else if (storedProductCount >= maxProducts && !revisitedProduct) {
                    parsedResponsed.shift(); // oldest remove
                    parsedResponsed.push(currentProductData);
                    localStorage.setItem('recently_viewed', JSON.stringify(parsedResponsed));
                }
            }
        }

        function displayRecentlyViewdProducts() {
            const storedProductData = JSON.parse(localStorage.getItem('recently_viewed')) || [];
            if (storedProductData.length === 0) return;

            const recentProductHtml = storedProductData.map(product => `
                <div class="col-md-3">
                    <body>
                        <div class="cont">
                            <div class="product-card">
                                <div class="product-card__image">
                                    {{ product.featured_image | image_url: width: 300 | image_tag }}
                                </div>
                                <div class="product-card__info">
                                    <h2 class="product-card__title">{{product.title}}</h2>
                                    <p class="product-card__description">{{ product.description | truncate: 30 }}</p>
                                    <div class="product-card__price-row">
                                        <span class="product-card__price">Price: {{ product.price | money }}</span>
                                        <a href="{{ product.url }}" class="product-card__btn">View Details</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </body>
                </div>

            `);


            $('#recently_viewed_products').html(recentProductHtml.join(''));
        }

        // Call functions
        updateRecentlyViewdProducts();
        displayRecentlyViewdProducts();
    });
</script>

{% schema %}
{
"name": "Recently Viewed Products",
"settings": [],
"presets": [
{
"name": "Recently Viewed Products"
}
]
}
{% endschema %}